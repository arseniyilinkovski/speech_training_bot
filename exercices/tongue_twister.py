import random
import json
import os
from exercices.base import BaseExercise


class TongueTwisterExercise(BaseExercise):
    """Ð£Ð¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ ÑÐ¾ ÑÐºÐ¾Ñ€Ð¾Ð³Ð¾Ð²Ð¾Ñ€ÐºÐ¾Ð¹"""

    def __init__(self):
        # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· JSON
        file_path = os.path.join(os.path.dirname(__file__), "..", "data", "texts.json")

        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            tongue_twisters = data.get("tongue_twisters", [])
        except (FileNotFoundError, json.JSONDecodeError):
            # Fallback Ð½Ð° Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
            tongue_twisters = [
                "Ð§ÐµÑ‚Ñ‹Ñ€Ðµ Ñ‡ÐµÑ€Ð½ÐµÐ½ÑŒÐºÐ¸Ñ… Ñ‡ÑƒÐ¼Ð°Ð·ÐµÐ½ÑŒÐºÐ¸Ñ… Ñ‡ÐµÑ€Ñ‚ÐµÐ½ÐºÐ° Ñ‡ÐµÑ€Ñ‚Ð¸Ð»Ð¸ Ñ‡ÐµÑ€Ð½Ñ‹Ð¼Ð¸ Ñ‡ÐµÑ€Ð½Ð¸Ð»Ð°Ð¼Ð¸ Ñ‡ÐµÑ€Ñ‚ÐµÐ¶.",
                "ÐšÐ°Ñ€Ð» Ñƒ ÐšÐ»Ð°Ñ€Ñ‹ ÑƒÐºÑ€Ð°Ð» ÐºÐ¾Ñ€Ð°Ð»Ð»Ñ‹, Ð° ÐšÐ»Ð°Ñ€Ð° Ñƒ ÐšÐ°Ñ€Ð»Ð° ÑƒÐºÑ€Ð°Ð»Ð° ÐºÐ»Ð°Ñ€Ð½ÐµÑ‚.",
                "Ð¨Ð»Ð° Ð¡Ð°ÑˆÐ° Ð¿Ð¾ ÑˆÐ¾ÑÑÐµ Ð¸ ÑÐ¾ÑÐ°Ð»Ð° ÑÑƒÑˆÐºÑƒ.",
                "Ð’Ð¾ Ð´Ð²Ð¾Ñ€Ðµ Ñ‚Ñ€Ð°Ð²Ð°, Ð½Ð° Ñ‚Ñ€Ð°Ð²Ðµ Ð´Ñ€Ð¾Ð²Ð°, Ð½Ðµ Ñ€ÑƒÐ±Ð¸ Ð´Ñ€Ð¾Ð²Ð° Ð½Ð° Ñ‚Ñ€Ð°Ð²Ðµ Ð´Ð²Ð¾Ñ€Ð°.",
                "Ð¡ÑˆÐ¸Ñ‚ ÐºÐ¾Ð»Ð¿Ð°Ðº Ð½Ðµ Ð¿Ð¾-ÐºÐ¾Ð»Ð¿Ð°ÐºÐ¾Ð²ÑÐºÐ¸, Ð¿ÐµÑ€ÐµÐºÐ¾Ð»Ð¿Ð°ÐºÐ¾Ð²Ð°Ñ‚ÑŒ Ð±Ñ‹ ÐºÐ¾Ð»Ð¿Ð°Ðº, Ð´Ð° Ð¿ÐµÑ€ÐµÐ²Ñ‹ÐºÐ¾Ð»Ð¿Ð°ÐºÐ¾Ð²Ð°Ñ‚ÑŒ."
            ]

        super().__init__(
            name="Ð¡ÐºÐ¾Ñ€Ð¾Ð³Ð¾Ð²Ð¾Ñ€ÐºÐ°",
            description="ÐŸÑ€Ð¾Ð¸Ð·Ð½ÐµÑÐ¸Ñ‚Ðµ ÑÐºÐ¾Ñ€Ð¾Ð³Ð¾Ð²Ð¾Ñ€ÐºÑƒ Ñ Ð¿Ñ€Ð¾Ð±ÐºÐ¾Ð¹ Ð²Ð¾ Ñ€Ñ‚Ñƒ",
            experience=15
        )
        self.tongue_twister = random.choice(tongue_twisters)

    async def execute(self, **kwargs):
        instructions = (
            f"ðŸ“ *Ð£Ð¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ: Ð¡ÐºÐ¾Ñ€Ð¾Ð³Ð¾Ð²Ð¾Ñ€ÐºÐ°*\n\n"
            f"*Ð¢ÐµÐºÑÑ‚:* {self.tongue_twister}\n\n"
            f"*Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ:*\n"
            f"1. Ð’Ð¾Ð·ÑŒÐ¼Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾Ð±ÐºÑƒ Ð¾Ñ‚ Ð±ÑƒÑ‚Ñ‹Ð»ÐºÐ¸ Ð¸Ð»Ð¸ Ð¿Ð¾Ñ…Ð¾Ð¶Ð¸Ð¹ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚\n"
            f"2. ÐŸÐ¾Ð¼ÐµÑÑ‚Ð¸Ñ‚Ðµ ÐµÐ³Ð¾ Ð¼ÐµÐ¶Ð´Ñƒ Ð·ÑƒÐ±Ð°Ð¼Ð¸\n"
            f"3. ÐŸÑ€Ð¾Ð¸Ð·Ð½ÐµÑÐ¸Ñ‚Ðµ ÑÐºÐ¾Ñ€Ð¾Ð³Ð¾Ð²Ð¾Ñ€ÐºÑƒ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ñ‡ÐµÑ‚ÐºÐ¾\n"
            f"4. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ð²Ð°ÑˆÐµÐ¹ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¾Ð¹\n\n"
            f"*Ð¡Ð¾Ð²ÐµÑ‚:* Ð¡Ñ‚Ð°Ñ€Ð°Ð¹Ñ‚ÐµÑÑŒ Ð²Ñ‹Ð³Ð¾Ð²Ð°Ñ€Ð¸Ð²Ð°Ñ‚ÑŒ ÐºÐ°Ð¶Ð´Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ ÑÑ‚Ð¾ ÑÐ»Ð¾Ð¶Ð½Ð¾!"
        )
        return {
            "text": instructions,
            "expect_voice": True,
            "data": {"tongue_twister": self.tongue_twister}
        }

    async def validate(self, voice_message) -> bool:
        """ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ"""
        # ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð´Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ 5 ÑÐµÐºÑƒÐ½Ð´
        return voice_message.duration >= 5