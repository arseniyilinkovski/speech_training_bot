import random
import json
import os
from exercices.base import BaseExercise


class ReadingExercise(BaseExercise):
    """Ð£Ð¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ Ð½Ð° Ñ‡Ñ‚ÐµÐ½Ð¸Ðµ Ð²ÑÐ»ÑƒÑ…"""

    def __init__(self):
        # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· JSON
        file_path = os.path.join(os.path.dirname(__file__), "..", "data", "texts.json")

        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            texts = data.get("reading_texts", [])
        except (FileNotFoundError, json.JSONDecodeError):
            # Fallback Ð½Ð° Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
            texts = [
                "Ð’ÐµÑ‚ÐµÑ€ Ð³ÑƒÐ´ÐµÐ» Ð² Ð¿Ñ€Ð¾Ð²Ð¾Ð´Ð°Ñ…, Ð·Ð°Ð²Ñ‹Ð²Ð°Ð» Ð² Ñ‚Ñ€ÑƒÐ±Ð°Ñ…, ÑÑ‚ÑƒÑ‡Ð°Ð» ÑÑ‚Ð°Ð²Ð½ÑÐ¼Ð¸. "
                "ÐšÐ°Ð·Ð°Ð»Ð¾ÑÑŒ, Ð²ÐµÑÑŒ Ð¼Ð¸Ñ€ Ð½Ð°Ð¿Ð¾Ð»Ð½Ð¸Ð»ÑÑ ÑÑ‚Ð¸Ð¼ Ð½ÐµÑƒÐ³Ð¾Ð¼Ð¾Ð½Ð½Ñ‹Ð¼ Ð·Ð²ÑƒÐºÐ¾Ð¼, "
                "ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ñ‚Ð¾ ÑƒÑÐ¸Ð»Ð¸Ð²Ð°Ð»ÑÑ, Ñ‚Ð¾ Ð·Ð°Ñ‚Ð¸Ñ…Ð°Ð», Ð½Ð¾ Ð½Ð¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ Ð¿Ñ€ÐµÐºÑ€Ð°Ñ‰Ð°Ð»ÑÑ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ.",
                "Ð¢Ñ€Ð¾Ð¿Ð¸Ð½ÐºÐ° Ð²Ð¸Ð»Ð°ÑÑŒ Ð¼ÐµÐ¶Ð´Ñƒ Ð´ÐµÑ€ÐµÐ²ÑŒÐµÐ², ÑƒÑ…Ð¾Ð´Ñ Ð²ÑÐµ Ð´Ð°Ð»ÑŒÑˆÐµ Ð² Ð³Ð»ÑƒÐ±ÑŒ Ð»ÐµÑÐ°. "
                "Ð¡Ð¾Ð»Ð½ÐµÑ‡Ð½Ñ‹Ðµ Ð»ÑƒÑ‡Ð¸ Ð¿Ñ€Ð¾Ð±Ð¸Ð²Ð°Ð»Ð¸ÑÑŒ ÑÐºÐ²Ð¾Ð·ÑŒ Ð³ÑƒÑÑ‚ÑƒÑŽ Ð»Ð¸ÑÑ‚Ð²Ñƒ, ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ "
                "Ð½Ð° Ð·ÐµÐ¼Ð»Ðµ Ð¿Ñ€Ð¸Ñ‡ÑƒÐ´Ð»Ð¸Ð²Ñ‹Ð¹ ÑƒÐ·Ð¾Ñ€ Ð¸Ð· ÑÐ²ÐµÑ‚Ð° Ð¸ Ñ‚ÐµÐ½Ð¸.",
                "ÐžÐ½ ÑÑ‚Ð¾ÑÐ» Ð½Ð° Ð±ÐµÑ€ÐµÐ³Ñƒ Ð¸ ÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ» Ð½Ð° Ñ€Ð°ÑÑÑ‚Ð¸Ð»Ð°ÑŽÑ‰ÑƒÑŽÑÑ Ð¿ÐµÑ€ÐµÐ´ Ð½Ð¸Ð¼ Ð³Ð»Ð°Ð´ÑŒ Ð²Ð¾Ð´Ñ‹. "
                "Ð’Ð¾Ð»Ð½Ñ‹ Ð¼ÑÐ³ÐºÐ¾ Ð½Ð°Ð±ÐµÐ³Ð°Ð»Ð¸ Ð½Ð° Ð¿ÐµÑÐ¾Ðº, Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑ Ð¿Ð¾ÑÐ»Ðµ ÑÐµÐ±Ñ Ð¿ÐµÐ½Ñƒ, "
                "ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ñ‚ÑƒÑ‚ Ð¶Ðµ Ð¸ÑÑ‡ÐµÐ·Ð°Ð»Ð°, Ð²Ð¿Ð¸Ñ‚Ñ‹Ð²Ð°ÑÑÑŒ Ð² Ð·ÐµÐ¼Ð»ÑŽ."
            ]

        super().__init__(
            name="Ð§Ñ‚ÐµÐ½Ð¸Ðµ Ð²ÑÐ»ÑƒÑ…",
            description="ÐŸÑ€Ð¾Ñ‡Ñ‚Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ñ‡ÐµÑ‚ÐºÐ¾ Ð¸ Ð²Ñ‹Ñ€Ð°Ð·Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾",
            experience=20
        )
        self.text = random.choice(texts)

    async def execute(self, **kwargs):
        instructions = (
            f"ðŸ“š *Ð£Ð¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ: Ð§Ñ‚ÐµÐ½Ð¸Ðµ Ð²ÑÐ»ÑƒÑ…*\n\n"
            f"*Ð¢ÐµÐºÑÑ‚ Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ:*\n{self.text}\n\n"
            f"*Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ:*\n"
            f"1. ÐŸÑ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð¹Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð²ÑÐ»ÑƒÑ… Ñ‡ÐµÑ‚ÐºÐ¾ Ð¸ Ð²Ñ‹Ñ€Ð°Ð·Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾\n"
            f"2. Ð¡Ð»ÐµÐ´Ð¸Ñ‚Ðµ Ð·Ð° Ð°Ñ€Ñ‚Ð¸ÐºÑƒÐ»ÑÑ†Ð¸ÐµÐ¹ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ ÑÐ»Ð¾Ð²Ð°\n"
            f"3. ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð´Ñ‹Ñ…Ð°Ð½Ð¸Ðµ Ð¸ Ñ‚ÐµÐ¼Ð¿ Ñ€ÐµÑ‡Ð¸\n"
            f"4. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ð²Ð°ÑˆÐ¸Ð¼ Ñ‡Ñ‚ÐµÐ½Ð¸ÐµÐ¼\n\n"
            f"*Ð¦ÐµÐ»ÑŒ:* Ð Ð°Ð·Ð²Ð¸Ñ‚ÑŒ Ð´Ð¸ÐºÑ†Ð¸ÑŽ Ð¸ Ð²Ñ‹Ñ€Ð°Ð·Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ñ€ÐµÑ‡Ð¸"
        )
        return {
            "text": instructions,
            "expect_voice": True,
            "data": {"text": self.text}
        }

    async def validate(self, voice_message) -> bool:
        return voice_message.duration >= 10